const resolve=require("../resolve/resolve"),implicitMultiplication=require("../implicit-multiplication/implicit-multiplication"),removeUnnecessary=require("../remove-unnecessary/remove-unnecessary"),simplify=require("../simplify/simplify"),resolveFunctions=e=>{let t=e;for(;/[a-z]+\((?!.*[a-z]+\()/.test(t);){let e,r,a=t.match(/[a-z]+\((?!.*[a-z]+\()/),n=a[0].slice(0,-1),s=a.end||a.index+a[0].length,l=getClosePosition(t,s),o=t.slice(s,l);if(/^(sin|sen|cos|tan|tg|sqrt|cbrt|ln|exp|abs|asin|asen|acos|atan|atg|sinh|senh|cosh|tanh|tgh|asinh|acosh|atanh|atgh|factorial|fact)$/.test(n))r=resolveParameter(o),e=resolveOneParam(n,r);else if(/^(pow|nroot|max|min)$/.test(n)){let t=o.split(",");e=resolveTwoParams(n,resolveParameter(t[0]),resolveParameter(t[1]))}else if("log"===n)if(/,/.test(o)){let t=o.split(",");e=resolveLog(resolveParameter(t[0]),resolveParameter(t[1]))}else r=resolveParameter(o),e=resolveLog(r,10);if(null===e||!isFinite(e))throw new Error(`Domain error in ${n}(${o}), result was: ${e}, because param was: ${r}`);const i=a.index>0?t[a.index-1]:"",c=l<t.length-1?t.slice(l+1):"";let u=formatNumber(e);/[\)\]\}\d]/.test(i)?u=/\d+|^[\(\[\{]|^[a-z][a-z]+\(/.test(c)?`*${u}*`:`*${u}`:/^\d+|^[\(\[\{]|^[a-z][a-z]+\(/.test(c)&&(u=`${u}*`),t=t.slice(0,a.index)+u+t.slice(l+1)}return t};function resolveParameter(e){if(!/[{([]/.test(e))return resolve(e);e=implicitMultiplication(e),e=removeUnnecessary(e),/[{([]/.test(e)&&(e=simplify(e));let t=resolve(e);if("Error! division by zero"===t)throw new Error("Error! division by zero");if("Error! 0 in potation of 0"===t)throw new Error("Error! 0 in potation of 0");let r=parseFloat(t);if(isNaN(r))throw new Error(`Invalid numeric result: ${t}`);return r}function resolveOneParam(e,t){switch(e){case"sin":case"sen":return Math.sin(t*Math.PI/180);case"cos":return Math.cos(t*Math.PI/180);case"tan":case"tg":return Math.abs(t%180-90)<1e-10?null:Math.tan(t*Math.PI/180);case"asin":case"asen":return t<-1||t>1?null:180*Math.asin(t)/Math.PI;case"acos":return t<-1||t>1?null:180*Math.acos(t)/Math.PI;case"atan":case"atg":return 180*Math.atan(t)/Math.PI;case"sqrt":return t<0?null:Math.sqrt(t);case"cbrt":return Math.cbrt(t);case"ln":return t<=0?null:Math.log(t);case"exp":let e=Math.exp(t);return isFinite(e)?e:null;case"sinh":case"senh":return Math.sinh(t);case"cosh":return Math.cosh(t);case"tanh":case"tgh":return Math.tanh(t);case"asinh":return Math.asinh(t);case"acosh":return t<1?null:Math.acosh(t);case"atanh":case"atgh":return t<=-1||t>=1?null:Math.atanh(t);case"abs":return Math.abs(t);case"factorial":case"fact":const r=Math.round(t);return Math.abs(t-r)>1e-10?(console.log(`Not an integer: ${t}`),null):r<0?(console.log(`Negative: ${r}`),null):r>170?(console.log(`Too large: ${r}`),null):factorial(r);default:return null}}function resolveTwoParams(e,t,r){switch(e){case"pow":if(0===t&&0===r)return null;if(t<0&&!Number.isInteger(r))return null;let e=Math.pow(t,r);return isFinite(e)?e:null;case"nroot":return 0===r||t<0&&r%2==0?null:Math.pow(t,1/r);case"max":return Math.max(t,r);case"min":return Math.min(t,r);default:return null}}function resolveLog(e,t){return e<=0||t<=0||1===t?null:Math.log(e)/Math.log(t)}function factorial(e){if(0===e||1===e)return 1;let t=1;for(let r=2;r<=e;r++)t*=r;return t}function getClosePosition(e,t){let r=1;for(let a=t;a<e.length;a++)if("("===e[a]&&r++,")"===e[a]&&r--,0===r)return a;return-1}function formatNumber(e){return Number.isInteger(e)?String(e):Math.abs(e)<1e-6||Math.abs(e)>1e15?e.toExponential():String(parseFloat(e.toFixed(10)))}module.exports=resolveFunctions;